{% extends "base/base.html" %}

{% block start %}

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
    .item-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
    }

    /* Mobile responsive fix */
    @media (max-width: 576px) {
        .item-row {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 10px;
        }

        .item-price {
            align-self: flex-end;
        }
    }
</style>

<div class="container my-5">

    <!-- ITEMS LIST -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h4 class="mb-3">Your Items</h4>

            {% for item in cart_items %}
            <div class="d-flex justify-content-between align-items-center border-bottom py-3 item-row">

                <div class="d-flex align-items-center gap-3">
                    <img src="{{ item.product.images.first.image.url }}"
                         class="item-image img-fluid"
                         alt="{{ item.product.name }}">

                    <div>
                        <p class="mb-0 fw-bold">{{ item.product.name }}</p>
                        <small class="text-muted">Qty: {{ item.quantity }}</small>
                    </div>
                </div>

                <p class="fw-bold mb-0 item-price">₹{{ item.product.price }}</p>
            </div>
            {% endfor %}

        </div>
    </div>

    <!-- SUMMARY -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">

            <div class="d-flex justify-content-between mb-2">
                <span class="fw-semibold">Subtotal:</span>
                <span>₹{{ subtotal }}</span>
            </div>

            <div class="d-flex justify-content-between fw-bold fs-5 border-top pt-2">
                <span>Total Payable:</span>
                <span>₹{{ order.amount }}</span>
            </div>

        </div>
    </div>

    <!-- Payment Button -->
    <div class="card shadow-sm mb-5">
        <div class="card-body text-center">
            <h4 class="mb-3">Complete Your Payment</h4>
            <button id="rzp-button" class="btn btn-primary btn-lg w-100">
                Pay Now
            </button>
        </div>
    </div>

</div>

<script>
    var options = {
        "key": "{{ razorpay_key }}",
        "amount": "{{ order.amount }}",
        "currency": "INR",
        "name": "Your Shop Name",
        "description": "Order Payment",
        "order_id": "{{ order.id }}",
        "handler": function (response) {
            fetch("/products/payment-status/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_signature: response.razorpay_signature
                })
            }).then(res => window.location.href = "/products/success/?status=" + res.status);
        },
        "theme": {
            "color": "#528FF0"
        }
    };

    var rzp1 = new Razorpay(options);

    document.getElementById("rzp-button").onclick = function (e) {
        rzp1.open();
        e.preventDefault();
    };
</script>

{% endblock %}
